---
title: "Specific leaf area in a coastal temperate deciduous forest: species and salinity effects"
author: "Lillie Haddock"
date: "8/13/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Packages, include=FALSE} 
## Load necessary packages
library(dplyr)
library(tidyr)
library(readr)
library(knitr)
library(kableExtra)
library(ggrepel)
library(ggplot2)
library(gganimate)
library(cowplot)
library(wesanderson)
theme_set(theme_bw())
```

## Motivation

Specific leaf area (SLA, the ratio of leaf area to leaf dry mass) is an important trait for plant physiological, structural, and modeling analyses. SLA is also a useful measurement to upscale plant production, vegetation community composition, and other processes in Earth System Models, providing current-day benchmarks and improving predictions of future vegetation structure and function in terrestrial ecosystems.

We investigate SLA differences between plots of varying elevation and salinity exposure along a tributary of the Chesapeake Bay. The goals of this project are to (i) quantify SLA of eight major tree species, at multiple canopy heights, in temperate deciduous forests at the Smithsonian Environmental Research Center (Maryland, USA); and (ii) test for effects of soil moisture and saltwater exposure on SLA by comparing samples taken at shoreline and upland positions, with the shoreline samples taken along a ~2 km tidal creek that provided a natural salinity gradient.

Map of SERC with plots labeled: 


## Methods

![Figure 1: Collecting samples using a hand pruner](Photos/sampling1.png) ![Figure 2: All the samples after a morning of collecting](Photos/sampling2.png)

## SLA Data

SLA is calculated using the ratio between a leaf's one-sided fresh leaf area and its total dry mass. 

```{r SLA Calculation}
## ----- Read in the SLA csv -----
sla_raw <- read.csv("SLA Data.csv", stringsAsFactors = FALSE) %>% 
  mutate(Tag = as.character(Tag)) 

## ----- SLA Calculation -----
sla_calc <- sla_raw %>% 
  mutate(specific_leaf_area = round(Leaf_Area_cm2 / Leaf_Mass_g, 3)) 
```

## Inventory Data
```{r SLA Inventory, error = FALSE}
## ----- Join with inventory data -----

## Read in the storm surge inventory data
ss_inventory <- read.csv("ss-inventory.csv", stringsAsFactors = FALSE) %>% 
  select(Plot, Species_code, Tag, DBH) %>% 
  mutate(Tag = as.character(Tag))

# Read in transplant inventory data
inventory <- read.csv("inventory.csv", stringsAsFactors = FALSE) %>% 
  select(Plot, Tag, Species_code, DBH = DBH_cm_2019) %>% 
  mutate(Tag = as.character(Tag)) %>% 
  bind_rows(ss_inventory)

shoreline_plots <- c("Shore", "HSLE", "MSLE", "LSLE")

# Create new dataset with plot, species, and tag columns
# by joining with the storm surge inventory data
sla_calc %>% 
  left_join(inventory, by = "Tag") %>% 
  # if NA DBH, then get information from what we measured in field
  mutate(DBH = if_else(is.na(DBH), No_Tag_DBH, DBH),
         Species_code = if_else(is.na(Species_code), No_Tag_Species_code, Species_code),
         Plot = if_else(is.na(Plot), No_Tag_Plot, Plot)) %>% 
  # We only want four letter species codes, and want to add an elevation column 
  mutate(Species_code = substr(Species_code, 1,4), 
         Elevation = if_else(Plot %in% shoreline_plots, "Shoreline", "Upland")) -> 
  sla_joined

# NEW: Want ONLY ACRU, FAGR, LIST, NYSY, QUAL, LITU species!
sla_joined_simple <- sla_joined %>% 
  filter(Species_code %in% c("ACRU", "FAGR", "LIST", "NYSY", "QUAL", "LITU"))

# At this point there should be NO data with an NA for Plot or DBH or Species_code
# Warn if this occurs
if(any(is.na(sla_joined_simple$DBH))) {
  warning("We still have unmatched trees!")  
}
if(any(sla_joined_simple$Species_code == "")) {
  warning("We have blank species codes!")  
}

## Join sla_joined_simple with plot species_codes
species_codes <- read.csv(file = "Design/species_codes.csv", stringsAsFactors = FALSE) 
sla <- left_join(sla_joined_simple, species_codes, by = "Species_code")

## Adding Salinity Column 
Shoreline_plots <- c("LSLE", "MSLE", "HSLE", "Shore")
Salinity <- c("Low Salinity", "Medium Salinity", "High Salinity", "High Salinity")
df <- data.frame(Shoreline_plots, Salinity)

sla_shoreline <- sla %>% 
   filter(Plot %in% c("LSLE", "MSLE", "HSLE", "Shore")) %>% 
   left_join(df, by = c("Plot" = "Shoreline_plots"))
  
```

### Summary Tables
```{r Summary Tables,echo= FALSE}
# Table 1
sla %>% 
  group_by(Species_common) %>% 
  summarise(n = n(), mean_SLA = mean(specific_leaf_area), sd_SLA = sd(specific_leaf_area)) %>% 
  knitr::kable(digits = 1, format = "html", 
               col.names = c("Species", "n", "Average SLA cm2/g", "SD"), 
               caption = "Table 1: Specific Leaf Area by Species") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive", full_width = FALSE))

# Elevation summary
sla %>% 
  group_by(Elevation) %>% 
  summarise(n = n(), mean_SLA = mean(specific_leaf_area), sd_SLA = sd(specific_leaf_area)) %>% 
  knitr::kable(digits = 1, format = "html", 
               col.names = c("Elevation", "n", "Average SLA cm2/g", "SD"),
               caption = "Table 2: SLA Elevation Gradient") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive", full_width = FALSE))

# Position summary
sla %>%
  group_by(Species_common, Position) %>% 
  summarise(n = n(), mean_SLA = mean(specific_leaf_area), sd_SLA = sd(specific_leaf_area)) %>% 
  knitr::kable(digits = 1, format = "html", 
               col.names = c("Species", "Canopy Position", "n", "Average SLA cm2/g", "SD"), 
               caption = "Table 3: SLA Canopy Position") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive", full_width = FALSE))

# Salinity
sla_shoreline %>%
   group_by(Species_common, Salinity) %>% 
   summarise(n = n(), mean_SLA = mean(specific_leaf_area), sd_SLA = sd(specific_leaf_area)) %>% 
  knitr::kable(digits = 1, format = "html", 
               col.names = c("Species", "Salinity Exposure", "n", "Average SLA cm2/g", "SD"),
               caption = "Table 4: SLA Along Salinity Gradient") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive", full_width = FALSE))

 sla_shoreline %>%
   group_by(Species_common, Salinity) %>% 
   summarise(mean_SLA = mean(specific_leaf_area)) %>% spread(Salinity, mean_SLA) %>% 
  knitr::kable(digits = 1, format = "html",
               col.names = c("Species", "High Salinity", "Low Salinity", "Medium Salinity"),
               caption = "Table 5: Average SLA (cm2/g) along Salinity Gradient for each Species") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive", full_width = FALSE))
  
 sla_shoreline %>%
   group_by(Species_common, Salinity) %>% 
   summarise(mean_SLA = paste(round(mean(specific_leaf_area), digits = 2), "+/-", round(sd(specific_leaf_area), digits = 2))) %>% 
   spread(Salinity, mean_SLA) %>% 
  knitr::kable(digits = 1, format = "html",
               col.names = c("Species", "High Salinity", "Low Salinity", "Medium Salinity"),
               caption = "Table 6: Average SLA (cm2/g) along Salinity Gradient") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive", full_width = FALSE))
```


### Quality Control Plots
```{r Quality Control Plots, echo = FALSE}
## leaves vs area
leaves_vs_area <- sla %>% 
  ggplot(aes(n_Leaves, Leaf_Area_cm2, color = Species_code)) +
  geom_point() +
  facet_wrap(~Species_code, scales = "free") +
  geom_smooth(method = lm) + 
  labs(title = "Number of Leaves vs. Leaf Area")
print(leaves_vs_area)

## leaves vs mass
leaves_vs_mass <- sla %>% 
  ggplot(aes(n_Leaves, Leaf_Mass_g, color = Species_code)) +
  geom_point() +
  facet_wrap(~Species_code, scales = "free") +
  geom_smooth(method = lm) +
  labs(title = "Number of Leaves vs. Leaf Dry Mass")
print(leaves_vs_mass)

```

### Results
```{r Average Specific Leaf Area, echo = FALSE}
#SLA Box Plot
sla_averages_plot <- sla %>% 
  ggplot(aes(Species_common, specific_leaf_area)) +
  labs(title = "Average Specific Leaf Area", x = "Species", y = "Average SLA (cm2/g)") +
  geom_boxplot(aes(fill = Species_common)) + 
  #geom_text(aes(label = round(Specific, 2)), vjust = 1.6, size = 3.3) +
  theme(axis.text.x = element_text(angle = 90)) +
  guides(fill=guide_legend(title="Species"))
print(sla_averages_plot)
```

```{r Specific Leaf Area by Elevation, echo = FALSE}
# Specific Leaf Area by Plot

sla_by_elev <- sla %>% 
  ggplot(aes(Species_common, specific_leaf_area, color = Elevation, fill = Elevation)) +
  geom_boxplot() +
  scale_color_manual(values = wes_palette(n = 2, name = "GrandBudapest1")) +
  scale_fill_manual(values = wes_palette(n = 2, name = "GrandBudapest1")) +
 theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Specific Leaf Area by Elevation", x = "Species", y = "Specific Leaf Area")
print(sla_by_elev)
```

```{r Specific Leaf Area by Species and Plot, echo = FALSE}
# Specific Leaf Area by Species
sla_by_species <- sla %>%
  group_by(Species_common, Elevation) %>% 
  summarise(avg_sla = mean(specific_leaf_area)) %>% 
  ggplot(aes(Elevation, avg_sla)) +
  geom_col() +
  facet_wrap(~Species_common) +
  #theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Specific Leaf Area by Species and Plot", y = "Specific Leaf Area (cm2/g)")
print(sla_by_species)
```

```{r Specific Leaf Area vs. Tree Diameter, echo = FALSE}
# The Relationship Between Specific Leaf Area and Tree Diameter at Breast Height
sla_vs_dbh <- sla %>% 
  ggplot(aes(DBH, specific_leaf_area, color = Species_common)) +
  geom_point() + 
  facet_wrap(~Species_common) +
  geom_smooth(method = "lm") +
  labs(title = "Specific Leaf Area vs. Tree Diameter", y = "Specific Leaf Area (cm2/g)", x = "Diameter at Breast Height (cm)", color = "Species")
print(sla_vs_dbh)
```

```{r Specific Leaf Area along Natural Salinity Gradient, echo = FALSE}
# The relationship between species and SLA along salinity gradient
HML <- c("High salinity", "Medium salinity", "Low salinity")

sla_sal_gradient <- sla %>% 
  filter(Plot %in% c("LSLE", "MSLE", "HSLE", "Shore")) %>% 
  # rename for clarity in this table only 
  mutate(Plot = if_else(Plot %in% c("HSLE", "Shore"), "High salinity", Plot),
         Plot = if_else(Plot == "MSLE", "Medium salinity", Plot),
         Plot = if_else(Plot == "LSLE", "Low salinity", Plot)) %>%
  mutate(Plot = factor(Plot, levels = HML)) %>% 
  group_by(Species_common, Plot) %>% 
  ggplot(aes(Plot, specific_leaf_area)) +
  geom_violin(aes(fill = Plot)) +
  theme(legend.position = "none") +
  labs(title = "Specific Leaf Area along Natural Salinity Gradient", y = "Specific Leaf Area (cm2/g)") +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n = 3))
print(sla_sal_gradient)

```

```{r GCREW SLA Comparison, echo = FALSE}
# Comparing GCREW SLA values from June to September
# group by tree, filter by more than one unique date

gcrew_comparison <- sla %>% 
  group_by(Tag) %>% 
  filter(n_distinct(Date) > 1)

```

## Statistics 
```{r Statistics, echo = FALSE}
# some statistics will happen here. But what??? Tune in to find out


```

## Leaf Area
```{r Leaf Area and SLA Analysis}
# Read in litter data
litter_1 <- read.csv("../SLA/litter/litterweight_20181012_20181015.csv", stringsAsFactors = FALSE)
litter_2 <- read.csv("../SLA/litter/litterweight_20181108.csv", stringsAsFactors = FALSE)
litter_3 <- read.csv("../SLA/litter/litterweight_20190705.csv", stringsAsFactors = FALSE)
litter_4 <- read.csv("../SLA/litter/litterweight_20190828_20190125_20190703_20191121_20191108.csv", stringsAsFactors = FALSE)
litter_5 <- read.csv("../SLA/litter/litterweight_transplants.csv", stringsAsFactors = FALSE)

# Combine all litter data into one data frame
litter_data_raw <- rbind.data.frame(litter_1, litter_2, litter_3, litter_4, litter_5)

# Need averages of each litter type for each plot
## Lets try this with M_woody first

avg_woody_mass <- litter_data_raw %>% 
  select(Plot:M_woody) %>% 
  filter(Plot == "LSLE") %>% 
  summarise(avg_mwoody_mass = mean(as.numeric(M_woody), na.rm=TRUE))
print(avg_woody_mass)

# Nice! 
# Now lets do this for all litter types and plots
avg_litter_mass <- litter_data_raw %>% 
  select(-Trap, -Date_weighed, -Date_collected) %>% 
  group_by(Plot) %>% 
  summarise(avg_mass_woody = mean(as.numeric((M_woody)), na.rm=TRUE), 
            avg_mass_repro = mean(as.numeric((M_reproductive)), na.rm=TRUE), 
            avg_mass_oak = mean(as.numeric((M_leaf_oak)), na.rm=TRUE),
            avg_mass_tulip = mean(as.numeric((M_leaf_tulip)), na.rm=TRUE), 
            avg_mass_beech = mean(as.numeric((M_leaf_beech)), na.rm=TRUE), 
            avg_mass_other = mean(as.numeric((M_leaf_other)), na.rm=TRUE)) %>% 
            cbind(avg_mass_total = colSums(M_woody:M_leaf_other))
print(avg_litter_mass)


```
